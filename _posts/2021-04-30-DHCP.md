# DHCP Nedir?
Cihazlara IP ataması yapan bu sistem internet bağlantıları için yol gösterici kurallar ve süreçler oluşturan bir protokoldür. Çalışma şekli olarak her cihaz için aynı mantık işler. DHCP sayesinde dinamik olarak IP adresi alan bir bilgisayar internette etkin rol alabilmektedir. DHCP'den IP adresi almak isteyen cihazlar DHCP sunucusuna giderler ve orada başka IP'ler ile çakışmadan kendi IP adresini alabilmektedir. Aynı zamanda farklı bir ağa bağlanmak isteyen bir cihazın, ağdaki Modem/Router'ın Default Gateway sayesinde DHCP yardımıyla bağlanabilmektedir.

## Kullanım Alanları
DHCP Server'lar ağda internete bağlanmak isteyen cihazlara IP adresi vermek için depo oluşturmuş ağdaki bir makinedir ve bir aynı ağdaki bilgisayarların farklı IP adresleri almasını sağlamaktadır. Aynı zamanda ağa bağlanan cihazın Subnet Mask'ının da belirlenmesini sağlamaktadır. Özellikle büyük çaplı ağlarda DHCP ile yapılandırma hem daha kolaydır hem de daha çok güvenilirdir, avantajlıdır.

## DHCP Başlık Bilgisi
![DHCP-header1-1-1024x549](https://user-images.githubusercontent.com/55113204/116402636-5522a900-a835-11eb-8deb-721af547ed74.png)

Opcode : Burası 8 bitlik alandır. Burada BOOT (önyükleme) isteği ve cevabı dönmektedir.
Hardware Type: 8 bitlik alandır. Ethernet, IEEE 802, ARCNET, LocalNet, LocalTalk, SMDS, Asenkron İletim Modu, ATM, Fiber Kanal, Frame Bayrağı, ISO 7816-3 üzerinden IP ve ARP istekleri, IPSec ve ARPSec tüneli, 	Wiegand Interface, Saf IP, MAPOS gibi hizmetleri sağlamaktadır.
Hardware address length: 8 bitlik alandır. 
Hop Count: 8 bitlik alandır. Bu alan relay agent (farklı subnette bulunan DHCP server üzerinden kendi subnetinizi dağıtım fırsatı veren servis) için kullanılır. 
Transaction ID: 32 bittir. Client (istemci) ile Server (sunucu) arasında mesajları ve ilişkiyi sağlamak için client tarafından seçilen rastgele sayılardır.
Number of seconds: 16 bitlik alandır. Client'ın bir adres edinmesi ve yenileme işlemine başlamasından bu yana geçen süreye denir.
Flags: 16 bitlik alandır. RFC 1542'e göre DHCP ve BOOTP Arasında Birlikte Çalışma belirlenmiştir.
Client IP Address: 32 bitlik alandır ve İstemcinin IP adresidir.
Your IP Address: 32 bitlik alandır ve sizin IP adresinizdir.
Server IP Address: 32 bitlik alandır ve sunucunun IP adresidir.
Gateway IP Address: 32 bitlik alandır. Bağlantının kurulduğu çıkış yolunun yani gatewayin IP adresidir.
Client hardware Address: 16 bitlik alandır. Burasının adresi client'ın interface adresidir. 
Server hostname: 16 bitlik alandır.
Boot filename: 128 bitlik alandır.
Options : Buranın uzunluğu değişkendir ve etiketli parametrelerin bir listesinden oluşmaktadır.

## DHCP Çalışma Mantığı
DHCP'nin en güzel çalışma şekli dinamik olmasıdır. Tek bir IP adresi veya da belirli bir IP adresine bağlı olmaksızın bir havuzdan yani çoğu bilgisayara atanmış bir subnetten (alt ağ) kullanılabilir bir IP atar. DHCP'nin aslında bir IP adresi ataması demek ona belirli bir süre için IP adresi kiralar demektir. Default olarak bu 5 günlük bir süredir. Şu şekilde çalışır. Öncelikle internete bağlanmak için cihazınızın internetini açın daha sonra burada bulunduğunuz ağ DHCP'nizden bir IP adresi ister. Bu isteğe discover mesaj denir. DHCP server bu istek üzerine cihaza bir IP adresi kiralar,verir. Buna DHCP offer mesajı denmektedir. Cihaz (client) gelen ilk teklif mesajındaki IP adresini kabul eder ve bunu kabul ettiğinden dolayı bu IP adresini doğrulamak adına DHCP request mesajı olarak yanıt vermektedir. Daha sonra DHCP sizin yeni IP adresinizi ve diğer yapılandırma işlemlerinizi ağ sunucularınızda güncelleme yapmaktadır. Bunuun sonucunda da dönen mesaja DHCP Ack mesajı denmektedir. Son olarakta cihazınız bu IP adresinizi kiralama süresinizce kabul etmeketedir. Bu kiralama süresi bittiğinde DHCP server otomatik olarak aynı yöntemlerle cihaza yeni bir IP adersi atmaktadır. 
Aşağıdaki görsellde de bu anlattığımız bu mantığı destekleyen görsel bulunmaktadır.
![csg68-01-how-dhcp-works](https://user-images.githubusercontent.com/55113204/116412325-3d502280-a83f-11eb-8348-63df50da770c.png)

## DHCP için kullanılan Portlar
DHCP relay ve DHCP proxy için router üzerinden yönlendirilen paketlerin DHCP servera ulaşması için UDP'nin hep source adresi hem destination adresi için 67. port kullanılmaktadır. Clientten servera giden paketler için 67. port kullanılırken Serverdan Clienta gidebilmek içinde 68. port kullanılmaktadır. 
![Ekran Alıntısı](https://user-images.githubusercontent.com/55113204/116414428-201c5380-a841-11eb-9dd2-2aaaa75d8ae1.PNG)
 
## DHCPDiscover, Offer, Request, ACK Mesajları
### DHCPDiscover Mesajı
Client bir IP adresi isteği zaman ilk olarak DHCPDiscover mesajını broadcast yapmaktadır. Bir server clienttan DHCPDiscover mesajı aldığı zaman ilk olarak client için bir ağ adresi seçimi yapar. Eğer mevcut olarak bir adres yoksa server durumu sistem yöneticisine bildirir. Yada adres mevcutsa şu şekilde adımlar izlenmektedir.
1- Clienttın mevcut olarak bağlantıda kayıtlı olduğu adresi verebilir, 
2- Clientın önceki adresi olan yani süresi dolmuş IP adresi veya serbest olarak IP havuzuna bırakılmış IP adresi hala duruyorsa bu verilebilir, 
3- Clientın istediği bir IP adresi hala geçerli ise ve başka bir cihaza verilmemiş ise bu IP adresi tahsis edilebilir,
4- Son olarakta Serverın belirlediği kullanılabilen bir IP adresi subnetine veya relay agenta göre verilebilmektedir.

DHCP Discovery mesajından sonra server clienta bir DHCP offer mesajı ile cevap vermektedir.

### DHCPOffer Mesajı
Burada hangi serverın client tarafından seçilip bu isteği aldığına bakılmaksızın bu sunucular tek tip dönüş yanıtı sağlamak amacıyla birden çok DHCP server clienta dönüş yapmaktadır. Dönüş mesajında clientın network adresini ve clientın IP adresini ne kadar süreyle kiralanacağı bilgisini taşımaktadır. Sistemde birden fazla DHCP server bulunma ihtimali vardır. Bu sebeple clienta en hızlı dönüş yapan server clienta IP adresi verebilmektedir. Bundan dolayı bu mesajda kendisini de tanıtmalıdır. Bu tanıtma Target IP Address (henüz belli olmadığı için değer 0.0.0.0'dır), Target MAC Address (client MAC adresi), Source IP Address (DHCP server IP adresi), Source MAC Address (DHCP server MAC adresi) bilgilerini de içermelidir. 

### DHCPRequest Mesajı
Bu mesaj DHCP Offer mesajına karşılık olarak yayınlanan mesajdır. Client bu mesaj ile aynı subnette kullanılabilir bir DHCP server olduğunu anlar. Bundan dolayı serverdan kendisi için kullanabileceği bir IP adresi de içeren network yapılandırılmasına sahip olan verileri ister. Burada IP adresini aldığını ve kullanacağını bildiren client, serverlara ben bu IP adresini aldım demek adına bir broadcast mesajı yollayarak diğer IP atamak isteyen serverlarla bağlantısını bitirir. Clientın IP isteğine birden çok server dönüş yapmış ise diğer serverlara başka bir serverla anlaştığını bildiren bir mesaj sonrası serverlar, network yapılandırma verilerini dahili olarak depolamaktadır. 

### DHCPAcknowledgement Mesajı
Clienttan Request mesajıyla dönüş alan bir DHCP server artık ona bir IP adresi verecek sunucu olduğunu anlamaktadır. Bundan dolayı DHCP server, clientın bilgilerini kayıt ederek ona bir IP adresi, subnet mask, DNS server IP adresi veya adresleri, Default gateway ve kiralama süresinin olduğu bir mesajla dönüş yapmaktadır. 

![Message-exchange-models-in-DHCP](https://user-images.githubusercontent.com/55113204/116435913-89599200-a854-11eb-95fb-066ef9f554d4.png)

## DHCP Relay Agent
DHCP relay agent kendi ağı dışındaki farklı bir server ile request ve replyleri iletmek için kullanılan herhangi bir TCP/IP ana makinesidir. Şu şekilde de yorumlanabilir farklı bir subnetteki DHCP serverdan kendi subnetindeki cihazlara IP adresi aldırarak iletişime geçmesini sağlayan cihazdır. Bu şekilde kendi ağının dışındaki cihazlarla iletişime geçilmesi sağlanmaktadır.

## DHCP Relay Agent Çalışma Mantığı
DHCP Relay Agent bir DHCP server ile DHCP client arasında bulunan bu cihaz aynı yerel ağ (LAN) üzerinde bulunmayan DHCP sunucusundan IP adresi almasını sağlamaktadır. Bir DHCP client bir IP adresi almak için yapılan DHCP isteğini her zaman broadcast adresini kullanarak yapar. Nasıl yapılandırıldığına bağlı olarak yerel bir subnete bağlı olan bir router ara birimi DHCP mesajı aldığında bu mesajı DHCP servera iletebilmektedir yada iptal edebilmektedir. İnterface DHCP relay olarak yapılandırılmamışsa mesajı iptal eder, yapılandırılmış ise mesajı DHCP servera iletebilmektedir. Bir router tek bir noktaya broadcast yapabildiği için ve DHCP mesajları da bir broadcast mesajları oldukları için routerın interfaceyi broadcast mesajını yeni bir tek noktaya broadcast mesajıyla sarar ve bu mesajı DHCP sunucusuna iletir. DHCP server tek bir noktadan broadcast mesajı aldığını isteğin bir DHCP clienttan olduğunu anlar ve DHCP relay tarafından yapıldığını da farkeder. Bunun sebebi bir DHCP clinet sadece tek bir DHCP servera broadcast yapmaz. DHCP server clienttan subnetini belirlemek için gelen tek bir noktaya broadcast mesajının source adresini kullanır. Default gateway IP adresi belirlendikten sonra DHCP server havuzlarını kontol ederek aynı default gatewayi kullanan havuzu bulur ve bu havuzdan kullanılabilecek IP adresini seçer ve tek bir noktaya broadcast mesajıyla sarar ve DHCP relaye geri gönderir. DHCP relay DHCP servardan bir tek noktaya broadcast mesajı aldığı zaman, bu mesajı yerel broadcast mesajına dönüştürür yerel subnete gönderir. Client DHCPOffer mesajını yerel broadcast mesaj olarak alır.

![dhcp-relay-agent](https://user-images.githubusercontent.com/55113204/116472921-31845080-a87f-11eb-933f-904b14ead684.jpg)

## DHCP Saldırıları
DHCP yoluyla gerçekleştirilen üç tip saldırı vardır. Bunlardan biri DHCP starvation saldırısı diğeri ise DHCP spoofing saldırısıdır.

### DHCP Starvation Saldırısı
DHCP serverları hedef alan dijital saldırıdır. Saldırgan DHCP serverın IP adreslerini bitirene kadar DHCP serverı fake DHCPDiscover mesajları ile doldurur. Eğer sunucu gelen bu mesajların hepsine cevap verirse havuzdaki IP paketlerinin hepsini tüketebilir. Ve DHCP server geçerli DHCP isteklerine sunacak daha fazla IP adresi olmadığına inanabilir. Aynı zamanda gerçek bir IP adresi isteyen clientlar kendileri için IP adresi verilmeyeceğini anlar ve bu saldırının üzerine DHCP server gerçek clientların isteklerini reddedebilir. Bundan dolayı clientlar başka bir DHCP server arayabilmektedir. Bu şekilde gerçek bir DHCP server kalmadığı zaman saldırgan kendi DHCP serverına istek atar ve saldırganın sunucu IP paketleri dağıtmaya başlar. Bu DHCP serverı kullanan clientlar artık saldırganın makinesi aracılığıyla yönlendirilmektedir. Hatta Middle in the man saldırısına yol açan alternatif bir DHCP bağlantısı da sağlayabilir. 

### DHCP Spoofing Saldırısı
Saldırganların sahte bir DHCP server kurduğu ve bu serverı ağdaki cihazlara fake DHCP yanıtı göndermek için kullanılan saldırıdır. Saldırgan kendisini default gateway veya DNS server olarak göstermeye çalıştığında bu saldırı gerçekleşmiş olur. Bunun sayesinde gerçek bir ağ trafiğine geçmeden önce kullanıcılardan gelen trafiği engelleyebilme veya gerçek bir DHCP serverı IP adresine boğarak cevap dönderemeyecek hale getirebilir. 

### DHCP Snooping Saldırısı 
DHCP isteğinde bulunan clientlara saldırgan tarafından tahsis edilen bir IP adresi verilir. Client bu cevabı aldığı zaman default gateway olarak bu sahte adresi kullanmaya başlar. Ağ dışındaki bir yere ulaşmak isteyen paketler öncelikle ağ dışına çıkmadan saldırganın makinesinin üstünden geçer daha sonra saldırgan bu paketleri gitmeyi istediği yere yönlendirir. Bu şekilde gelen giden tüm paketleri izleme olanağı bulur. İsterse clientten gelen yönlendirme isteğini istediği servera da gönderebilir. Kendi istediği internet sitesine de yönlendirebilir. Sadece belirli portlar üzerinden DHCP Snoopingin izni ile güvenli yada güvensiz ilan edilebilir. Bu şekilde güvensiz portlardan paket aktarımına izin veirlmez ve buradan gelen DHCP cevapları çöpe atılır.

### DHCP Resource Starvation Saldırısı Nedir?
Bu saldırı fake MAC adresleri ile DHCP requestlerini broadcast yapar. Yeterli sayıda istek gönderirse, bir süre sonra DHCP serverlardaki kullanılabilecek IP adresleri tüketilebilir. Saldırgan daha sonra bu istekleri karşılamak için sahte bir DHCP server kurabilir ve ağdaki DHCP clientlardan gelen requestlere cevap verebilmektedir. Yani DHCP request tüketimi sonucunda sahte bir serverdan DHCP request oluşumunu sağlayan saldırı türüne DHCP Resource Starvation saldırısı denir. Saldırgan ağa bağladığı bu sahte server ile clientlara adresler ve diğer ağ bilgileri sağlayabilmektedir. İstediği yere yönlendirmede yapabilmektedir. Ağın trafiğini izleyip kontrol de edebilir. 

## Rouge DHCP Server Deployment Nedir?
Sahte bir DHCP serverın ağı kandırmasıdır. Sahte olan DHCP server gerçek bir DHCP clienttan gelen trafiği yakalayıp yeniden yönlendirebilir. Rouge DHCP serverlar iletişimleri engellemek ve trafiği gizlice dinlemek için kullanılabilir. İsterse bu server sayesinde tüm trafiği bir ağ üzerine de yönlendirebilirler. Rogue DHCP server, DHCP server ile deneme yapan bir client tarafından yanlışlıkla ağa tanıtılan yanlış yapılandırılmış veya yanlış yetkilendirilmiş bir serverdır. Rouge serverlar clientlara yanlış bir IP adresi atadığında clientler geçerli domain controllerları (DC) bulamayabilir bundan dolayıda clientların ağda oturum açılmaları engellenmiş olur. Yada IP kiralamalarının yenileme requestlerini geri çevirebilir. 

## DHCP Saldırılarından Korunma Yöntemleri
DHCP snooping ekipmanları ile güvenilmeyen DHCP serverın trafiğini engelleyebilir. Yada bu DHCP gözetleme ekipmanı ile IP adreslerini, MAC adreslerini veya karşılıklı gelen portları izleyerek yalnızda güvenilir kombinasyonların iletişim kurmasını sağlamaktadır. Ağ spoofing yağmak için birçok araç mevcuttur. Bu araçların bazı DHCP server tarama araçlarının anlık ileti uyarı ve e-posta uyarı yetenekleri vardır. Bu sebeple güvenilmez bir DHCP server buldukları zaman sistem yöneticisini uyarabilmektedirler. BAşka bir yol ise networkun bölümlere ayrılmasıdır. Bu şekilde eğer bir parça sahte bir DHCP server tarafından kandırılıyorsa diğer ağlar bundan etkilenmeyebilir. Son olarak da şüpheli adreslere karşı beklenmeyen bir anda DNS trafiği gibi fake client yapılandırılmasına ait kanıtlar toplamak için ağ trafiği izlenmesidir. Avantajları ise eski bir düzene yeni bir perspektif getiriyor olmasıdır. Bu şekilde etkili olarak tehtid azaltma stratejileri geliştirilebilir.

## DHCP Saldırı Araçları
DHCP Sentry, Roadkil.net's DHCP Find, Dhcploc.exe, dhcp_probe, DHCPig, dstar, DHCP-Starvation.py,OpUtils’ DHCP, yersinia
